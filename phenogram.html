<!DOCTYPE html>
<html>

<head>
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"
        integrity="sha256-oP6HI9z1XaZNBrJURtCoUT5SUnxFr8s3BzRl+cbzUq8=" crossorigin="anonymous"></script>
    </script>
    <style>
        .phenogram_header {
            width: 300px;
            height: 100px;
            position: absolute;
            top: 0;
            left: 0;
            font-size: 12px;
        }

        .phenogram_button {
            font-size: medium;
            position: absolute;
            color: hsl(270 100% 50%);
            bottom: 0;
            right: 0;
        }

        input.phenogram_header {
            visibility: hidden;
        }

        .phenogram_svg {
            position: absolute;
            top: 0;
            left: 0;
        }

        .marker_drag {
            opacity: 0;
            cursor: grab;
        }

        .marker_label {
            user-select: none;
            font-family: sans-serif;
            cursor: grab;
        }

        .divergence_label {
            user-select: none;
            font-family: sans-serif;
        }

        .marker_selected {
            user-select: none;
            font-family: sans-serif;
            cursor: grab;
        }

        .marker_grabbed {
            user-select: none;
            cursor: grabbing;
        }

        rect.marker_legend {
            user-select: none;
            fill: white;
        }

        text.marker_legend {
            fill: black;
        }

        #marker_legend {
            visibility: hidden;
        }

        .marker_legend {
            opacity: 1;
            position: relative;
            font-family: sans-serif;
        }

        .marker_expression {
            display: inline;
        }

        .taxon_divergence {
            display: inline;
        }

        polygon.taxon_divergence {
            stroke: black;
            stroke-width: 2;
        }

        text.marker_selected {
            fill: hsl(270 100% 50%);
        }

        circle.marker_selected {
            stroke: hsl(270 100% 50%);
            stroke-width: 3px;
        }

        text.marker_grabbed {
            fill: hsl(300 100% 50%);
        }

        circle.marker_grabbed {
            stroke: hsl(300 100% 50%);
            stroke-width: 3px;
        }

        .large_population {
            fill: black;
            stroke: black;
        }

        .small_population {
            fill: white;
            stroke: black;
            stroke-width: 2px;
        }

        .taxon_similarity {
            stroke: black;
            stroke-width: 3px;
        }

        .species_taxon {
            stroke: gray;
            stroke-width: 2px;
        }
    </style>
</head>

<body>
    <div id="phenogram"></div>

    <div id="markers">

["FSC-A","IgG3:FITC-A","CD10:Brilliant Violet 650-A","CD21:Brilliant Violet 705-A","IgA:APC-A","CD38:Alexa Fluor 700-A","IgG1:PE-A","CD27:PE-Texas Red-A","IgD:PE-Cy5-A"]

    </div>
    <div id="taxonomy">

{"ID":13,"depth":0.0,"dissimilarity":null,"height":4,"index":5.09375,"markers":[0.28340841912681997,0.28251994744898495,0.27828652771123913,0.3691759042287105,0.30374868123656584,0.3709023631938787,0.3535086409674453,0.5793119035275485,0.35649537286599653],"population":53369,"rank":0,"sibling":[],"subtaxa":[{"ID":9,"depth":1.138810893876119,"dissimilarity":0.4505713310940313,"height":3,"index":3.6875,"markers":[0.2697945281955423,0.3030873880932703,0.29311035472809294,0.4206264817132047,0.31112836139632605,0.2390240716866585,0.417459273940844,0.4873335375256117,0.30156674849119214],"population":52996,"rank":1,"sibling":[0],"subtaxa":[{"ID":7,"depth":2.032325334795497,"dissimilarity":0.35351961696335665,"height":2,"index":2.375,"markers":[0.2701060341944833,0.3598368876295926,0.2887890616960175,0.425736646970316,0.3386781231360969,0.23628718740994553,0.2260929472814517,0.4615049242048741,0.341112315633485],"population":50840,"rank":2,"sibling":[0,1],"subtaxa":[{"ID":3,"depth":3.3654934561473526,"dissimilarity":0.5274689048373101,"height":1,"index":0.5,"markers":[0.27168021968897815,0.21990741734760624,0.28702594961165795,0.4553028380812659,0.26637190934747,0.24132140066229008,0.22420017639189252,0.40653436517068986,0.5615445045342896],"population":47613,"rank":3,"sibling":[0,1,2],"subtaxa":[{"ID":1,"covariance":[0.0019893140713035874,-5.984835861500931e-06,0.0006044365418477216,-0.00022127025264997375,-0.00018647916666137082,0.006223283180384741,0.00020021054598833078,-0.0002846387044969995,-0.00013156182754444723,0.007396833722349708,-3.0011982423345218e-05,9.999297270091688e-05,-0.000456434136980265,-7.200595725866476e-05,0.006937168872589898,-6.48693301011902e-05,-2.8346933405926598e-06,0.0024887454517885897,-0.0006263925278967946,-0.0012168451623897328,0.005031861902073166,-7.02113349866538e-06,2.6257676092572385e-05,9.800822834428527e-05,-0.00013485202135702572,9.974897400811058e-05,-1.767120597725059e-05,0.0006489071277314216,-8.39154684420815e-05,0.00016250831889556364,-4.3818369436470456e-05,3.993281691589641e-05,0.00015655007194775825,-0.0005295099277312801,-0.00019556310100994192,0.002662130635637469,0.0004803332620334278,0.0003351430718758355,-0.0005716636861694539,-0.00023396215079832358,-0.00136259207980953,0.0015521895140797226,-0.00031273455632162685,-0.0013047138509648943,0.015255600647288538],"depth":3.98620893068492,"dissimilarity":0.24558651405338489,"divergence":1.8456250163331807,"gating":14,"height":0,"index":0.0,"markers":[0.2715222817533231,0.21001117878906841,0.29347843685622665,0.4620126088719116,0.2582634000506782,0.25964757352321,0.2229463446436423,0.2679149352386693,0.6176066402202848],"population":26153,"rank":4,"sibling":[0,1,2,3],"supertaxon":3,"taxa":1,"types":1},{"ID":2,"covariance":[0.0029234034571452576,0.00011977341634365932,0.0008980426303163277,-1.7229326083134463e-05,-5.870787721243759e-05,0.0024277251021740266,-1.657142767027691e-05,-0.0005525690015782201,0.000255736108591354,0.009901727005207814,9.846589413456331e-06,8.127737140986226e-05,-0.0002037236755018876,7.965899760803278e-05,0.004581373542616028,2.9816179837490648e-06,7.985902822315262e-05,0.00021299083074147822,-0.0006003075372914705,-0.0005410589102914175,0.0025007921724971966,-3.3034360467520798e-09,3.9291165076286496e-05,0.00011610600881026148,-7.045924428428254e-05,1.4498615140411832e-06,9.872710393687253e-06,0.0006790724433352853,0.0003068757844611021,0.0009473080774996119,-0.0002353806826554729,-0.001724639129680968,-1.9075916808852797e-05,8.267567849921566e-05,0.0001487592682278435,0.007491516831744739,0.000400782007870467,0.0010578060297762224,-0.0010851098881071227,-0.001257351732978433,-0.0009931231394798114,0.0007296366533519116,-0.00022665206485503745,0.0009410768337202709,0.02422332250953028],"depth":3.9999999999999996,"dissimilarity":0.2510429603272305,"divergence":1.7854398535705447,"gating":15,"height":0,"index":1.0,"markers":[0.2718416666929703,0.23002353074013465,0.280430100871372,0.44844398946372854,0.27466057367235636,0.2225880565118298,0.2254818657999867,0.5482336444781967,0.5042367791523505],"population":21460,"rank":4,"sibling":[0,1,2],"supertaxon":3,"taxa":1,"types":1}],"supertaxon":7,"taxa":3,"types":2},{"ID":4,"covariance":[0.00293552263519721,0.00011292806302396368,0.0007581518066849608,-1.9520567359632467e-05,-0.00011553828788547149,0.004745346156256058,0.00015997402097964923,-0.00041582132108221586,0.0006581886930701165,0.009254197741854526,0.000254337116574597,0.000409682921689104,-0.00095329436381881,-0.001073290335627833,0.006612986358422211,-0.000155630648971406,9.239380463462585e-05,0.0006136033140677302,-0.00041903475615629506,-0.0006001525183763867,0.0034081158810041322,9.752633556093038e-07,5.976686063660308e-05,6.033452211682509e-06,-0.00014829498849528138,7.295124133763517e-05,1.9401332253997765e-05,0.00048359031333182153,0.00025693621847877916,0.0009451713322794572,-0.0006450768156075897,-0.000742817199916551,0.0019180607753215765,-0.0006855494345574779,0.00010915724146405716,0.014066554114242317,0.00027621425500474334,0.00012720768318457825,-1.405022455868474e-06,-0.0004374752106236212,-0.00014579001447877,0.0002073830170833352,4.484564667153722e-05,0.00113332411491142,0.00450123544953614],"depth":3.5274782695436717,"dissimilarity":0.5915583101823709,"divergence":1.7481692650656315,"gating":13,"height":0,"index":2.0,"markers":[0.27245163671494127,0.22568551936412615,0.2907554662930395,0.46753835375163066,0.5249367351938,0.2276523331554606,0.22721981050254447,0.5414277365998429,0.20576222954362483],"population":2801,"rank":3,"sibling":[0,1,2],"supertaxon":7,"taxa":1,"types":1},{"ID":5,"covariance":[0.00395071934871032,0.0008733681483531932,0.0045778242510515765,0.00017798598328241748,-0.000641421089737567,0.00316514044492792,0.0007218513676715235,-0.0017725789936169473,0.0010692357389389376,0.011134041400994938,-0.00041601070482087524,0.00045267664996669494,-0.00038886935682352615,-0.0010881996586261393,0.0026776480417400146,-0.0004223105357812302,-0.0007109306069815409,-0.00023201573934478924,-4.981140479346535e-05,-2.706238903132758e-05,0.0029848082526541184,2.157558004690365e-05,7.435615283386059e-05,4.506597776970859e-05,-0.00028556421301630027,8.088639236427299e-05,0.00011238655577252871,0.00037302072881723383,0.00013551828230547836,-0.0005016096944026687,9.276117633497006e-05,0.0018453963444756026,-0.0004327377748370443,0.00038461782995220643,-0.0003453608541174737,0.004879993346488758,0.0009112537528947048,0.0007119750885698511,-6.582698015519095e-05,0.00016629079928553572,-0.0015664042825631233,-0.0006966840297102843,-1.9464780262864475e-07,9.842790826690198e-05,0.004229527869026061],"depth":3.5403012581595523,"dissimilarity":0.5966317346467223,"divergence":1.7495882327741392,"gating":6,"height":0,"index":3.0,"markers":[0.26740145224006207,0.568676688763649,0.29175112910194484,0.37964694358442475,0.2821181413789862,0.24065922268721612,0.22623891856300232,0.3101306878642677,0.21752895952359727],"population":219,"rank":3,"sibling":[0,1,2],"supertaxon":7,"taxa":1,"types":1},{"ID":6,"covariance":[0.003598147891601534,0.0006476859476394526,0.004338481830192199,0.00041027719502764677,-0.00035613634105445714,0.00245042227813435,0.0009160719597645154,-0.0002227890502584437,0.000841879371133588,0.012372933127329911,0.00012020112383222427,0.00029275695513946885,-1.287120832164027e-05,0.0003753367550194997,0.0026824852698800025,-0.0005566519261304382,-0.0006850999098313342,-0.0002925229649424151,0.0004054668835610883,-0.0005173631498539698,0.0034669122287978756,-4.45212571460308e-05,-3.0579965265655505e-05,4.09713381958774e-05,-8.388462040740992e-05,6.799308019115332e-05,-1.5590926406275184e-05,0.0004920536478025101,0.00035867556019568637,0.0007885190501900929,-0.0004508645246470772,-0.00030029609384947217,0.0005874374295994204,-0.00046312404312593027,0.00015153122164261813,0.006153007869103445,0.00011987523292191063,0.0005518491782818095,-0.00018416821410920743,-0.0003884777843778131,-5.8451261477222835e-05,-0.000367837415660415,6.326477951293282e-05,0.0009940782613746695,0.003567401438069113],"depth":3.5542146641614867,"dissimilarity":0.6021365835167625,"divergence":1.83599180043255,"gating":7,"height":0,"index":4.0,"markers":[0.26681407771392723,0.5849205824200082,0.2864081316092164,0.36217992713197994,0.27912018566891766,0.23420926266246372,0.22790442320747653,0.607666363750679,0.24289781099932206],"population":207,"rank":3,"sibling":[0,1],"supertaxon":7,"taxa":1,"types":1}],"supertaxon":9,"taxa":7,"types":5},{"ID":8,"covariance":[0.0034759202150546308,4.778436756456766e-05,0.0008078440666298745,6.469098803372605e-05,-3.8755782099303415e-05,0.0040479198200801085,0.000662654024123888,-0.0003636046055416854,0.0009555838457806528,0.013449484560261382,-0.00011600964647525987,0.0001627402734886088,-0.0002617908693682545,-0.0005577257928596055,0.002650479150026625,-0.0004382018510385328,0.00011464072470520158,0.0002892516230598606,-0.0006644859277699983,-0.00014143698920127088,0.004151203596860729,0.0002864852097683521,0.00032999124711257814,-0.00021728583523477138,-0.002463078811956033,-1.1354958280037863e-05,0.0002160230730248839,0.012069526752779771,0.0006967732160003837,0.0009146894371658572,-0.0007158153981407288,-0.0014419891892072597,0.00033532648195167106,-0.0005023265442452197,0.004085617081338417,0.02076910315440303,0.0001588304488050014,2.6912728026221057e-05,-0.00035893698800223007,0.00019099348196563773,-0.002063654225883908,8.937972454595116e-07,0.0016743948044871616,0.0012118670119314954,0.006947598647701172],"depth":2.4082383444372533,"dissimilarity":0.502249863609798,"divergence":1.8681822938382804,"gating":3,"height":0,"index":5.0,"markers":[0.26935196761905816,0.22246264470032726,0.2992496712803702,0.4133664042514391,0.2719880607953651,0.24291239835577627,0.6893358738584952,0.5240285804457202,0.2453838529727026],"population":2156,"rank":2,"sibling":[0],"supertaxon":9,"taxa":1,"types":1}],"supertaxon":13,"taxa":9,"types":6},{"ID":12,"depth":1.975250071779079,"dissimilarity":0.7815090801035968,"height":1,"index":6.5,"markers":[0.30702150465647415,0.24684603633046703,0.25257482655300767,0.27993566476856935,0.2909487389075467,0.5996432420935458,0.24258724651091795,0.7388469721016389,0.45176823144374467],"population":373,"rank":1,"sibling":[],"subtaxa":[{"ID":10,"covariance":[0.007711565566747006,0.0006319430818169287,0.0009737148249588534,0.0008950906267380029,0.0005389326611096064,0.005178561163955049,-8.335708434170366e-05,0.00037950484194672666,0.00011444772381942169,0.012562567384239949,-0.0008429982899298987,0.0005236175178993089,0.0020969008043300067,0.0022468359936868936,0.011305859144380863,-0.00032292565684193924,0.00037919603283039237,0.000269849594306899,-0.0004884757992416301,0.0003465807980621341,0.004061296140299626,-8.476134828637329e-05,5.891997182994647e-05,0.0017282454194844485,-0.0003786774504320376,0.001674048753209379,0.000479325789464593,0.0031661830079141137,0.001160932802170626,0.00021991523157685036,-0.00021785888969614073,-0.000566148415186946,-0.0010107698999196185,0.00014138725711161082,0.00024037004982732573,0.005214083136130831,0.0013104077615646876,0.0010739806556996703,-0.000649311669535393,0.0018642725690684824,-0.0018005367893201688,0.00020512186771324927,-0.00028173102070749726,0.001600241772053879,0.014467543504328127],"depth":2.6798363378943963,"dissimilarity":0.2787700517279089,"divergence":1.8550491660088824,"gating":10,"height":0,"index":6.0,"markers":[0.3158959121931167,0.2507578507775352,0.25886107537718045,0.2833593679680711,0.2515446893909636,0.589217887322108,0.24283505786387694,0.7541045946734292,0.6427072709514982],"population":210,"rank":2,"sibling":[0,1],"supertaxon":12,"taxa":1,"types":1},{"ID":11,"covariance":[0.0076897632645735355,0.0006668568564952508,0.0009605827512327291,0.0018081916430089922,0.0005007916540905773,0.004138149107215133,-0.0006735592010946772,-0.00011933268823903827,-0.0011680709932562429,0.014805410831767429,0.001771607654376438,0.0007523369304325931,0.0008859397418579659,0.0008498505744215518,0.00901486997601265,-0.0017860274379730358,0.00032088494309955864,6.030049764376524e-05,-0.0013440729912838716,-6.851392100025056e-05,0.006025213233212612,0.0002620331646379088,0.00013083227653895574,-0.00022228172885083454,-0.0003749125780848112,-6.770311660680791e-05,0.00045114376287725197,0.0013086496014795628,0.0010030618317885983,0.0005481203449972577,0.0008074617954408446,-0.00028876706462308043,0.0013182278586772876,0.0006114506851997318,0.0005614463109669686,0.005427305182750856,0.000124967096203516,7.734767769470555e-05,0.0007080443928740353,0.0006639186067847059,-0.002282697951921881,-0.00035805849649758314,0.00038696296845136107,0.00021676284691885455,0.006286932429263552],"depth":2.699952834550776,"dissimilarity":0.28672915777804775,"divergence":1.4290067483158793,"gating":11,"height":0,"index":7.0,"markers":[0.29789372574697975,0.2428225364787447,0.24610910033971425,0.27641421212761896,0.33147780528646303,0.6103662490113381,0.2423323599473099,0.7231537323056555,0.2553777309374575],"population":163,"rank":2,"sibling":[0],"supertaxon":12,"taxa":1,"types":1}],"supertaxon":13,"taxa":3,"types":2}],"supertaxon":3452816845,"taxa":13,"types":8}

    </div>
    <script>
        var taxonomy, markers;
        var phenogram = {};
        phenogram.expr_min = 1;
        phenogram.expr_max = 0;
        phenogram.divrg_min = 1E10;
        phenogram.divrg_max = 0;
        phenogram.permute = [];
        phenogram.invert = [];
        phenogram.down_marker = -1, phenogram.up_marker = -1;

        function coord(position) {
            let coordinate = "";
            coordinate += 32 * position;
            coordinate += "";
            return coordinate;
        }

        function diverge(divergence) {
            let color = "hsl(" + (120 * (phenogram.divrg_max - divergence) / (phenogram.divrg_max - phenogram.divrg_min)) + " 80% 50%)";
            return color;
        }

        function express(expression) {
            let color = "hsl(" + (240 * (phenogram.expr_max - expression) / (phenogram.expr_max - phenogram.expr_min)) + " 80% 50%)";
            return color;
        }

        function rangeExpression(taxon) {
            if (taxon["subtaxa"])
                for (subtaxon of taxon.subtaxa)
                    rangeExpression(subtaxon);
            else {
                for (const expression of taxon.markers)
                    if (expression > phenogram.expr_max)
                        phenogram.expr_max = expression;
                    else if (expression < phenogram.expr_min)
                        phenogram.expr_min = expression;
                if (taxon.divergence > phenogram.divrg_max)
                    phenogram.divrg_max = taxon.divergence;
                else (taxon.divergence < phenogram.divrg_min)
                phenogram.divrg_min = taxon.divergence;
            }
        }

        function reorderMarkers() {
            for (let i = 0; i < markers.length + 1; ++i) {
                let transform = "translate(" + coord(phenogram.permute[i]) + "," + coord(0) + ")";
                $("#marker" + i + "expression").attr("transform", transform);
                $("#marker" + i + "legend").attr("transform", transform);
            }
        }

        function renderTaxonomy(taxon, tree, expression) {
            if (taxon["subtaxa"]) {
                for (subtaxon of taxon.subtaxa) {
                    let line = document.createElementNS("http://www.w3.org/2000/svg", "line");
                    line.setAttribute("x1", coord(taxon.depth));
                    line.setAttribute("y1", coord(taxon.index));
                    line.setAttribute("x2", coord(subtaxon.depth));
                    line.setAttribute("y2", coord(subtaxon.index));
                    line.setAttribute("class", "taxon_similarity");
                    tree.appendChild(line);
                }
                let circle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
                circle.setAttribute("cx", coord(taxon.depth));
                circle.setAttribute("cy", coord(taxon.index));
                let p = taxon.population / taxonomy.population;
                if (p > .01) {
                    circle.setAttribute("r", 10 * Math.sqrt(p));
                    circle.setAttribute("class", "large_population");
                }
                else {
                    circle.setAttribute("r", 10 * Math.sqrt(p * 100));
                    circle.setAttribute("class", "small_population");
                }
                tree.appendChild(circle);

                for (subtaxon of taxon.subtaxa)
                    renderTaxonomy(subtaxon, tree, expression);
            }
            else {
                line = document.createElementNS("http://www.w3.org/2000/svg", "line");
                line.setAttribute("x1", coord(taxon.depth));
                line.setAttribute("y1", coord(taxon.index));
                line.setAttribute("x2", coord(taxonomy.height + .5));
                line.setAttribute("y2", coord(taxon.index));
                line.setAttribute("class", "species_taxon");
                tree.appendChild(line);

                let circle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
                circle.setAttribute("cx", coord(taxon.depth));
                circle.setAttribute("cy", coord(taxon.index));
                let p = taxon.population / taxonomy.population;
                if (p > .01) {
                    circle.setAttribute("r", 10 * Math.sqrt(p));
                    circle.setAttribute("class", "large_population");
                }
                else {
                    circle.setAttribute("r", 10 * Math.sqrt(p * 100));
                    circle.setAttribute("class", "small_population");
                }
                tree.appendChild(circle);

                for (i = 0; i < markers.length; ++i) {
                    let circle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
                    circle.setAttribute("cx", coord(0));
                    circle.setAttribute("cy", coord(taxon.index));
                    circle.setAttribute("r", 10);
                    circle.setAttribute("fill", express(taxon.markers[i]));
                    circle.setAttribute("class", "marker" + i + "expression");
                    expression[i].appendChild(circle);
                }

                let diamond = document.createElementNS("http://www.w3.org/2000/svg", "polygon");
                diamond.setAttribute("points", "0,-12 10,0 0,12, -10,0");
                diamond.setAttribute("fill", diverge(taxon.divergence));
                diamond.setAttribute("transform", "translate(0," + coord(taxon.index) + ")");
                expression[markers.length].appendChild(diamond);
            }
        }

        function render(taxonomy, markers) {
            window.taxonomy = taxonomy;
            for (let i = 0; i < markers.length + 1; ++i) {
                phenogram.permute[i] = i;
                phenogram.invert[i] = i;
            }
            rangeExpression(taxonomy);

            let svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
            svg.setAttribute("height", coord(3 + taxonomy.types));
            svg.setAttribute("width", coord(taxonomy.height + markers.length + 4));
            svg.setAttribute("class", "phenogram_svg");

            let clip = document.createElementNS("http://www.w3.org/2000/svg", "clipPath");
            clip.setAttribute("id", "legend_clip");

            let rect = document.createElementNS("http://www.w3.org/2000/svg", "rect");
            rect.setAttribute("height", coord(3));
            rect.setAttribute("width", coord(markers.length + 4));
            rect.setAttribute("x", coord(-.5));
            rect.setAttribute("y", coord(-3));
            clip.appendChild(rect);
            svg.appendChild(clip);

            let drawing = document.createElementNS("http://www.w3.org/2000/svg", "g");
            drawing.setAttribute("height", "inherit");
            drawing.setAttribute("width", "inherit");
            svg.appendChild(drawing);

            let tree = document.createElementNS("http://www.w3.org/2000/svg", "g");
            tree.setAttribute("height", coord(taxonomy.types));
            tree.setAttribute("width", coord(taxonomy.height));
            tree.setAttribute("transform", "translate(" + coord(.5) + "," + coord(3.5) + ")");
            drawing.appendChild(tree);

            let expression = document.createElementNS("http://www.w3.org/2000/svg", "g");
            expression.setAttribute("height", coord(taxonomy.types));
            expression.setAttribute("width", coord(markers.length));
            expression.setAttribute("transform", "translate(" + coord(taxonomy.height + 1.5) + "," + coord(3.5) + ")");
            drawing.appendChild(expression);

            var expression_groups = [];
            for (let i = 0; i < markers.length; ++i) {
                let group = document.createElementNS("http://www.w3.org/2000/svg", "g");
                group.setAttribute("height", coord(taxonomy.types));
                group.setAttribute("width", coord(1));
                group.setAttribute("id", "marker" + i + "expression");
                group.setAttribute("class", "marker_expression");
                expression.appendChild(group);
                expression_groups.push(group);

                let text = document.createElementNS("http://www.w3.org/2000/svg", "text");
                text.setAttribute("clip-path", "url(#legend_clip)")
                text.setAttribute("x", coord(0));
                text.setAttribute("y", coord(-.5));
                text.setAttribute("class", "marker_label");
                text.setAttribute("transform", "rotate(-45 " + coord(0) + " " + coord(-.5) + ")");
                text.innerHTML = markers[i];
                group.appendChild(text);
            }

            let group = document.createElementNS("http://www.w3.org/2000/svg", "g");
            group.setAttribute("height", coord(taxonomy.types));
            group.setAttribute("width", coord(1));
            group.setAttribute("class", "taxon_divergence");
            group.setAttribute("transform", "translate(" + coord(markers.length) + "," + coord(0) + ")");
            expression.appendChild(group);
            expression_groups.push(group);

            let text = document.createElementNS("http://www.w3.org/2000/svg", "text");
            text.setAttribute("clip-path", "url(#legend_clip)")
            text.setAttribute("x", coord(0));
            text.setAttribute("y", coord(-.5));
            text.setAttribute("class", "divergence_label");
            text.setAttribute("transform", "rotate(-45 " + coord(0) + " " + coord(-.5) + ")");
            text.innerHTML = "Divergence";
            group.appendChild(text);

            let animation = document.createElementNS("http://www.w3.org/2000/svg", "g");
            animation.setAttribute("height", "inherit");
            animation.setAttribute("width", "inherit");
            svg.appendChild(animation);

            let drag = document.createElementNS("http://www.w3.org/2000/svg", "g");
            drag.setAttribute("clip-path", "url(#legend_clip)")
            drag.setAttribute("height", coord(3));
            drag.setAttribute("width", coord(markers.length + 4));
            drag.setAttribute("id", "marker_drag");
            drag.setAttribute("class", "marker_drag");
            drag.setAttribute("transform", "translate(" + coord(taxonomy.height + 1.5) + "," + coord(3) + ")");
            animation.appendChild(drag);

            for (i = 0; i < markers.length; ++i) {
                let rect = document.createElementNS("http://www.w3.org/2000/svg", "rect");
                rect.setAttribute("width", coord(4) * Math.sqrt(2));
                rect.setAttribute("height", coord(1) / Math.sqrt(2));
                rect.setAttribute("x", coord(i - 1 / Math.sqrt(2)));
                rect.setAttribute("y", coord(0));
                rect.setAttribute("class", "marker_drag");
                rect.setAttribute("transform", "rotate(-45 " + coord(i - 1 / Math.sqrt(2)) + " " + coord(0) + ")");
                rect.setAttribute("onclick", "marker_click(" + i + ")");
                rect.setAttribute("ondblclick", "marker_click(" + i + ")");
                rect.setAttribute("onmouseover", "marker_over(" + i + ")");
                rect.setAttribute("onmouseout", "marker_out(" + i + ")");
                rect.setAttribute("onmouseup", "marker_up(" + i + ")");
                rect.setAttribute("onmousedown", "marker_down(" + i + ")");

                let group = document.createElementNS("http://www.w3.org/2000/svg", "g");
                group.appendChild(rect);
                drag.appendChild(group);
            }

            let legend = document.createElementNS("http://www.w3.org/2000/svg", "g");
            legend.setAttribute("clip-path", "url(#legend_clip)")
            legend.setAttribute("height", coord(3));
            legend.setAttribute("width", coord(markers.length + 4));
            legend.setAttribute("id", "marker_legend");
            legend.setAttribute("class", "marker_legend");
            legend.setAttribute("transform", "translate(" + coord(taxonomy.height + 1.5) + "," + coord(3) + ")");
            animation.appendChild(legend);

            rect = document.createElementNS("http://www.w3.org/2000/svg", "rect");
            rect.setAttribute("class", "marker_legend");
            rect.setAttribute("height", coord(3));
            rect.setAttribute("width", coord(markers.length + 4));
            rect.setAttribute("x", coord(-.5));
            rect.setAttribute("y", coord(-3));
            legend.appendChild(rect);

            for (i = 0; i < markers.length; ++i) {
                let text = document.createElementNS("http://www.w3.org/2000/svg", "text");
                text.setAttribute("class", "marker_legend");
                text.setAttribute("x", coord(0));
                text.setAttribute("y", coord(0));
                text.setAttribute("transform", "rotate(-45 " + coord(0) + " " + coord(0) + ")");
                text.innerHTML = markers[i];

                let group = document.createElementNS("http://www.w3.org/2000/svg", "g");
                group.setAttribute("id", "marker" + i + "legend");
                group.appendChild(text);
                legend.appendChild(group);
            }

            text = document.createElementNS("http://www.w3.org/2000/svg", "text");
            text.setAttribute("class", "marker_legend");
            text.setAttribute("x", coord(0));
            text.setAttribute("y", coord(0));
            text.setAttribute("transform", "rotate(-45 " + coord(0) + " " + coord(0) + ")");
            text.innerHTML = "Divergence";

            group = document.createElementNS("http://www.w3.org/2000/svg", "g");
            group.setAttribute("id", "marker" + markers.length + "legend");
            group.appendChild(text);
            legend.appendChild(group);

            for (let i = 0; i < taxonomy.types; ++i) {
                let rect = document.createElementNS("http://www.w3.org/2000/svg", "rect");
                rect.setAttribute("height", coord(1));
                rect.setAttribute("width", coord(markers.length + 1));
                rect.setAttribute("x", coord(taxonomy.height + 1));
                rect.setAttribute("y", coord(i + 3));
                rect.setAttribute("opacity", 0);
                rect.setAttribute("onmouseover", "expression_over(" + i + ")");
                rect.setAttribute("onmouseout", "expression_out(" + i + ")");
                animation.appendChild(rect);
            }

            let div = document.createElement("div");
            div.setAttribute("class", "phenogram_header");
            text = document.createTextNode(
                "Solid black circle area is proportional to population. " +
                "Open circles are 100X. " +
                "Closer together means greater similarity. " +
                "Warmer colors mean higher marker expression.");
            div.appendChild(text);
            for (let i = 0; i < markers.length; ++i) {
                let checkbox = document.createElement("input");
                checkbox.setAttribute("type", "checkbox");
                checkbox.setAttribute("checked", true);
                checkbox.setAttribute("id", "marker" + i + "visible");
                checkbox.setAttribute("class", "phenogram_header");
                checkbox.setAttribute("onchange", "visibility_changed(" + i + ")");
                div.appendChild(checkbox);
            }
            let checkbox = document.createElement("input");
            checkbox.setAttribute("type", "checkbox");
            checkbox.setAttribute("checked", true);
            checkbox.setAttribute("id", "all_or_none");
            checkbox.setAttribute("class", "phenogram_header");
            checkbox.setAttribute("onchange", "all_or_none()");
            div.appendChild(checkbox);

            let button = document.createElement("label");
            button.setAttribute("for", "all_or_none");
            button.setAttribute("class", "phenogram_button");
            button.innerHTML = "None";
            div.appendChild(button);

            renderTaxonomy(taxonomy, tree, expression_groups);

            let doc = document.getElementById("phenogram")
            doc.appendChild(svg);
            doc.appendChild(div);

            $(document).ready(function () {
                $("div.phenogram_header").css("width", coord(taxonomy.height + 1));
                $("div.phenogram_header").css("hight", coord(3));

                reorderMarkers();
            });
        }

        function marker_click(i) {
            $("#marker" + phenogram.invert[i] + "visible").click();
        }

        function visibility_changed(i) {
            if ($("#marker" + i + "visible").prop("checked"))
                $("#marker" + i + "expression circle").css("visibility", "");
            else
                $("#marker" + i + "expression circle").css("visibility", "hidden");
        }

        function all_or_none() {
            if ($("#all_or_none").prop("checked")) {
                $(".phenogram_button").html("None");
                $("input.phenogram_header").prop("checked", true).trigger("change");
            }
            else {
                $(".phenogram_button").html("All");
                $("input.phenogram_header").prop("checked", false).trigger("change");
            }
        }

        function marker_over(i) {
            $("#marker" + phenogram.invert[i] + "expression *").attr("class", "marker_selected");
        }

        function marker_out(i) {
            if (i != phenogram.down_marker)
                $("#marker" + phenogram.invert[i] + "expression *").attr("class", "marker_label");
        }

        function marker_down(i) {
            phenogram.down_marker = i;
            $("#marker" + phenogram.invert[i] + "expression *").attr("class", "marker_grabbed");
        }

        function marker_up(i) {
            phenogram.up_marker = i;
            if (phenogram.up_marker > phenogram.down_marker) {
                for (let m = 0; m < markers.length; ++m) {
                    if (phenogram.permute[m] > phenogram.up_marker || phenogram.permute[m] < phenogram.down_marker)
                        continue;
                    if (phenogram.permute[m] == phenogram.down_marker)
                        phenogram.permute[m] = phenogram.up_marker;
                    else
                        --phenogram.permute[m];
                }
            }
            else if (phenogram.down_marker > phenogram.up_marker) {
                for (let m = 0; m < markers.length; ++m) {
                    if (phenogram.permute[m] > phenogram.down_marker || phenogram.permute[m] < phenogram.up_marker)
                        continue;
                    if (phenogram.permute[m] == phenogram.down_marker)
                        phenogram.permute[m] = phenogram.up_marker;
                    else
                        ++phenogram.permute[m];
                }
            }
            for (let m = 0; m < markers.length; ++m)
                phenogram.invert[phenogram.permute[m]] = m;

            phenogram.down_marker = -1;

            $(".marker_expression *").attr("class", "marker_label");
            reorderMarkers();
        }

        function expression_over(i) {
            $("#marker_legend").attr("transform", "translate(" + coord(taxonomy.height + 1.5) + "," + coord(3 + i) + ")");
            $("#marker_legend").css("visibility", "visible");
        }

        function expression_out(i) {
            $("#marker_legend").css("visibility", "");
        }

        let e = document.getElementById("markers");
        markers = JSON.parse(e.innerText);
        e.innerText = "";
        e = document.getElementById("taxonomy");
        taxonomy = JSON.parse(e.innerText);
        e.innerText = "";
        render(taxonomy, markers);
    </script>
</body>

</html>
